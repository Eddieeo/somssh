{% extends 'base.html' %}
{% block css %}
{% endblock %}

{% block header %}
{% endblock %}

{% block content %}
    <div class="right_col" role="main">
        <div class="">
            <div class="clearfix"></div>

            <div class="row">


                <div class="top_tiles">
                    <div class="animated flipInY col-lg-3 col-md-3 col-sm-6 col-xs-12">
                        <div class="tile-stats">
                            <div class="icon"><i class="fa fa-user"></i></div>
                            <div id="login-count" class="count">0</div>
                            <h3>在线人数</h3>
                            <p>目前登录发布系统人数.</p>
                        </div>
                    </div>
                    <div class="animated flipInY col-lg-3 col-md-3 col-sm-6 col-xs-12">
                        <div class="tile-stats">
                            <div class="icon"><i class="fa fa-desktop"></i></div>
                            <div id="host-count" class="count">0</div>
                            <h3>管理主机</h3>
                            <p>包括已禁用主机<b class="red" id="host-disabled"> 0 </b>台.</p>
                        </div>
                    </div>
                </div>
                <div class="animated flipInY col-lg-3 col-md-3 col-sm-6 col-xs-12">
                    <div class="tile-stats">
                        <div class="icon"><i class="fa fa-sitemap"></i></div>
                        <div id="project-count" class="count">0</div>
                        <h3>项目数量</h3>
                        <p>包括已禁用项目<b class="red" id="project-disabled"> 0 </b>个.</p>
                    </div>
                </div>
                <div class="animated flipInY col-lg-3 col-md-3 col-sm-6 col-xs-12">
                    <div class="tile-stats">
                        <div class="icon"><i class="fa fa-tasks"></i></div>
                        <div id="job-count" class="count">0</div>
                        <h3>任务总数</h3>
                        <p>其中有<b class="green" id="job-todo"> 0 </b>个未结单任务、<b class="red" id="job-cancle"> 0 </b>个作废工单.
                        </p>
                    </div>
                </div>


                <div class="col-md-4 col-sm-4 col-xs-12">
                    <div class="x_panel tile fixed_height_320">
                        <div class="x_title">
                            <h2>系统状态</h2>
                            <ul class="nav navbar-right panel_toolbox">
                                <li><a class="collapse-link"><i class="fa fa-chevron-up"></i></a>
                                </li>
                                <li class="dropdown">
                                    <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button"
                                       aria-expanded="false"><i class="fa fa-wrench"></i></a>
                                    <ul class="dropdown-menu" role="menu">
                                        <li><a href="#">Settings 1</a>
                                        </li>
                                        <li><a href="#">Settings 2</a>
                                        </li>
                                    </ul>
                                </li>
                                <li><a class="close-link"><i class="fa fa-close"></i></a>
                                </li>
                            </ul>
                            <div class="clearfix"></div>
                        </div>
                        <div class="x_content">
                            {#                  <h4>处理器</h4>#}
                            <div class="widget_summary">
                                <div class="w_left w_25">
                                    <span>Salt版本</span>
                                </div>
                                <div class="w_center w_75">
                                    <span>{{ salt_version }}</span>
                                </div>
                                <div class="clearfix"></div>
                            </div>
                            <div class="widget_summary">
                                <div class="w_left w_25">
                                    <span>主机名</span>
                                </div>
                                <div class="w_center w_75">
                                    <span>{{ hostname }}</span>
                                </div>
                                <div class="clearfix"></div>
                            </div>
                            <div class="widget_summary">
                                <div class="w_left w_25">
                                    <span>操作系统</span>
                                </div>
                                <div class="w_center w_75">
                                    <span>{{ os }}</span>
                                </div>
                                <div class="clearfix"></div>
                            </div>
                            <div class="widget_summary">
                                <div class="w_left w_25">
                                    <span>配置</span>
                                </div>
                                <div class="w_center w_75">
                                    <span>CPU: {{ cpu_core }}核 内存: {{ mem_total }}GB</span>
                                </div>
                                <div class="clearfix"></div>
                            </div>
                            <div class="widget_summary">
                                <div class="w_left w_25">
                                    <span>开机时间</span>
                                </div>
                                <div class="w_center w_75">
                                    <span id="boot_time"></span>
                                </div>
                                <div class="clearfix"></div>
                            </div>
                            <div class="widget_summary">
                                <div class="w_left w_25">
                                    <span>运行时间</span>
                                </div>
                                <div class="w_center w_75">
                                    已运行 <span id="online_time"></span>
                                </div>
                                <div class="clearfix"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-4 col-sm-4 col-xs-12">
                    <div class="x_panel tile fixed_height_320">
                        <div class="x_title">
                            <h2>资源使用</h2>
                            <ul class="nav navbar-right panel_toolbox">
                                <li><a class="collapse-link"><i class="fa fa-chevron-up"></i></a>
                                </li>
                                <li class="dropdown">
                                    <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button"
                                       aria-expanded="false"><i class="fa fa-wrench"></i></a>
                                    <ul class="dropdown-menu" role="menu">
                                        <li><a href="#">Settings 1</a>
                                        </li>
                                        <li><a href="#">Settings 2</a>
                                        </li>
                                    </ul>
                                </li>
                                <li><a class="close-link"><i class="fa fa-close"></i></a>
                                </li>
                            </ul>
                            <div class="clearfix"></div>
                        </div>
                        <div class="x_content" style="height:250px;overflow:auto;">
                            {#                  <h4>处理器</h4>#}
                            <div class="widget_summary">
                                <div class="w_left w_35">
                                    <span>处理器</span>
                                </div>
                                <div class="w_center w_65">
                                    <div class="progress progress-striped active">
                                        <div id="cpu" class="progress-bar bg-success" role="progressbar"
                                             aria-valuenow="0"
                                             aria-valuemin="0" aria-valuemax="100" style="width: 0;">
                                            <span id="cpu_per"></span>%
                                        </div>
                                    </div>
                                </div>
                                {#                                <div class="w_right w_20">#}
                                {#                                    <span>100%</span>#}
                                {#                                </div>#}
                                <div class="clearfix"></div>
                            </div>

                            <div class="widget_summary">
                                <div class="w_left w_35">
                                    <span>内存使用</span>
                                </div>
                                <div class="w_center w_65">
                                    <div class="progress progress-striped active">
                                        <div id="mem" class="progress-bar bg-success" role="progressbar"
                                             aria-valuenow="0"
                                             aria-valuemin="0" aria-valuemax="100" style="width: 0;">
                                            <span id="mem_per"></span>%
                                        </div>
                                    </div>
                                </div>
                                <div class="clearfix"></div>
                            </div>
                            {% for i in disk_info %}
                                <div class="widget_summary">
                                    <div class="w_left w_35">
                                        <span>分区 {{ i }}</span>
                                    </div>
                                    <div class="w_center w_65">
                                        <div class="progress progress-striped active">
                                            <div id="disk-{{ i|cut:'/' }}" class="progress-bar bg-success"
                                                 role="progressbar" aria-valuenow="0"
                                                 aria-valuemin="0" aria-valuemax="100" style="width: 0;">
                                                <span id="disk-per-{{ i|cut:'/' }}"></span>%
                                            </div>
                                        </div>
                                    </div>
                                    <div class="clearfix"></div>
                                </div>
                            {% endfor %}

                        </div>
                    </div>
                </div>

                <div class="col-md-4 col-sm-4 col-xs-12">
                    <div class="x_panel tile fixed_height_320 overflow_hidden">
                        <div class="x_title">
                            <h2>网络带宽</h2>
                            <ul class="nav navbar-right panel_toolbox">
                                <li><a class="collapse-link"><i class="fa fa-chevron-up"></i></a>
                                </li>
                                <li class="dropdown">
                                    <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button"
                                       aria-expanded="false"><i class="fa fa-wrench"></i></a>
                                    <ul class="dropdown-menu" role="menu">
                                        <li><a href="#">Settings 1</a>
                                        </li>
                                        <li><a href="#">Settings 2</a>
                                        </li>
                                    </ul>
                                </li>
                                <li><a class="close-link"><i class="fa fa-close"></i></a>
                                </li>
                            </ul>
                            <div class="clearfix"></div>
                        </div>
                        <div class="x_content">
                            <div id="main" style="width: auto;height:240px;"></div>
                        </div>
                    </div>
                </div>

                <div class="col-md-12 col-sm-12 col-xs-12">
                    <div class="x_panel overflow_hidden">
                        <div class="x_title">
                            <h2>任务发布情况</h2>
                            <ul class="nav navbar-right panel_toolbox">
                                <li><a class="collapse-link"><i class="fa fa-chevron-up"></i></a>
                                </li>
                                <li class="dropdown">
                                    <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button"
                                       aria-expanded="false"><i class="fa fa-wrench"></i></a>
                                    <ul class="dropdown-menu" role="menu">
                                        <li><a href="#">Settings 1</a>
                                        </li>
                                        <li><a href="#">Settings 2</a>
                                        </li>
                                    </ul>
                                </li>
                                <li><a class="close-link"><i class="fa fa-close"></i></a>
                                </li>
                            </ul>
                            <div class="clearfix"></div>
                        </div>
                        <div class="x_content">
                            <div id="main-release" style="height:350px;"></div>
                        </div>
                    </div>
                </div>


                <div class="col-md-4 col-sm-4 col-xs-12">
                    <div class="x_panel">
                        <div class="x_title">
                            <h2>创建任务前10项目
                                <small>PROJECT TOP 10</small>
                            </h2>
                            <ul class="nav navbar-right panel_toolbox">
                                <li><a class="collapse-link"><i class="fa fa-chevron-up"></i></a>
                                </li>
                                <li class="dropdown">
                                    <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button"
                                       aria-expanded="false"><i class="fa fa-wrench"></i></a>
                                    <ul class="dropdown-menu" role="menu">
                                        <li><a href="#">Settings 1</a>
                                        </li>
                                        <li><a href="#">Settings 2</a>
                                        </li>
                                    </ul>
                                </li>
                                <li><a class="close-link"><i class="fa fa-close"></i></a>
                                </li>
                            </ul>
                            <div class="clearfix"></div>
                        </div>
                        <div class="x_content">
                            <ul class="list-unstyled timeline">
                                {% for p in project_info %}
                                    <li>
                                        <div class="block">
                                            <div class="tags">
                                                <p class="tag">
                                                    <span><b>Top {{ forloop.counter }}</b></span>
                                                </p>
                                            </div>
                                            <div class="block_content">
                                                <h2 class="title">
                                                    <a>项目：{{ p.0.name }}</a>
                                                </h2>
                                                <div class="byline">
                                                    <span>创建时间：{{ p.0.created_time }}</span>
                                                </div>
                                                <p class="excerpt">
                                                    当前版本 {{ p.0.version }}，所属主机组 {{ p.0.host_group.groupname }}，目前已创建任务 {{ p.1 }}
                                                    个.
                                                </p>
                                            </div>
                                        </div>
                                    </li>
                                {% endfor %}
                            </ul>

                        </div>
                    </div>
                </div>

                <div class="col-md-4 col-sm-4 col-xs-12">
                    <div class="x_panel">
                        <div class="x_title">
                            <h2>创建任务前10用户
                                <small>USER TOP 10</small>
                            </h2>
                            <ul class="nav navbar-right panel_toolbox">
                                <li><a class="collapse-link"><i class="fa fa-chevron-up"></i></a>
                                </li>
                                <li class="dropdown">
                                    <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button"
                                       aria-expanded="false"><i class="fa fa-wrench"></i></a>
                                    <ul class="dropdown-menu" role="menu">
                                        <li><a href="#">Settings 1</a>
                                        </li>
                                        <li><a href="#">Settings 2</a>
                                        </li>
                                    </ul>
                                </li>
                                <li><a class="close-link"><i class="fa fa-close"></i></a>
                                </li>
                            </ul>
                            <div class="clearfix"></div>
                        </div>
                        <div class="x_content">
                            <ul class="list-unstyled timeline">
                                {% for u in user_info %}
                                    <li>
                                        <div class="block">
                                            <div class="tags">
                                                <p href="" class="tag">
                                                    <span><b>Top {{ forloop.counter }}</b></span>
                                                </p>
                                            </div>
                                            <div class="block_content">
                                                <h2 class="title">
                                                    <a>用户：{{ u.0.first_name }}</a>
                                                </h2>
                                                <div class="byline">
                                                </div>
                                                <p class="excerpt">
                                                    加入时间：{{ u.0.date_joined }}，所属用户组 {{ u.0.group.group_name }}，目前已创建任务 {{ u.1 }}
                                                    个.
                                                </p>
                                            </div>
                                        </div>
                                    </li>
                                {% endfor %}
                            </ul>

                        </div>
                    </div>
                </div>

                <div class="col-md-4 col-sm-4 col-xs-12">
                    <div class="x_panel">
                        <div class="x_title">
                            <h2>最近发布记录
                                <small>JOB TOP 10</small>
                            </h2>
                            <ul class="nav navbar-right panel_toolbox">
                                <li><a class="collapse-link"><i class="fa fa-chevron-up"></i></a>
                                </li>
                                <li class="dropdown">
                                    <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button"
                                       aria-expanded="false"><i class="fa fa-wrench"></i></a>
                                    <ul class="dropdown-menu" role="menu">
                                        <li><a href="#">Settings 1</a>
                                        </li>
                                        <li><a href="#">Settings 2</a>
                                        </li>
                                    </ul>
                                </li>
                                <li><a class="close-link"><i class="fa fa-close"></i></a>
                                </li>
                            </ul>
                            <div class="clearfix"></div>
                        </div>
                        <div class="x_content">
                            <div class="dashboard-widget-content">

                                <ul id="log-info" class="list-unstyled timeline widget">
                                    {% for l in log_info %}
                                        <li>
                                            <div class="block">
                                                <div class="block_content">
                                                    <h2 class="title">
                                                        <span id="{{ l.id }}">发布项目：{{ l.project }}</span>
                                                    </h2>
                                                    <div class="byline">
                                                        <span>发布时间：{{ l.created_time }}</span> by
                                                        <span>{{ l.user }}</span>
                                                    </div>
                                                    <p class="excerpt">任务ID：{{ l.jid }}，发布批次：{{ l.batch }}，发布类型：
                                                        {% if l.msg_type %}项目回退{% else %}项目发布{% endif %}，发布结果：
                                                        {% if l.status %}成功{% else %}失败{% endif %}.
                                                    </p>
                                                </div>
                                            </div>
                                        </li>
                                        {% if forloop.last %}
                                            <div id="append_log"></div>
                                            <a href="javascript:void(0)" onclick="log_info(1);" role="button"
                                               style="margin-top:15px;"
                                               class="col-md-12 col-sm-12 col-xs-12 btn btn-sm btn-dark">查看更多</a>
                                        {% endif %}
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
{% endblock %}

{% block js %}
    <script src="/static/echarts/echarts.common.min.js"></script>
    <script src="/static/js/csrf.js"></script>
    <script type="text/javascript">
        $(document).ready(function () {
            get_info();
            get_sys_usage();
            {#        setInterval("get_sys_usage()", 30000);#}
            setTimeout(function () {
                get_info();
                get_sys_usage();
                setTimeout(arguments.callee, 10000);
            }, 10000);
            setTimeout(function () {
                get_info();
                get_sys_usage();
                getNetInfo();
                setTimeout(arguments.callee, 5000);
            }, 5000)
        });

        function log_info(lid) {
            $.ajax({
                type: "POST",
                url: "{% url 'index' %}",
                data: {req_type: 'log_info', 'last_id': lid},
                dataType: "json",
                success: function (ret) {
                    if (ret.length < {{ num }}) {
                        $("#log-info a").html("没有更多了.").removeClass("btn-dark").addClass("btn-default").removeAttr("onclick");
                        return false;
                    }
                    var html = "";
                    for (i in ret) {
                        if (ret[i].msg_type) {
                            msg = '回退';
                        } else {
                            msg = '发布';
                        }
                        if (ret[i].status) {
                            status = '成功';
                        } else {
                            status = '失败';
                        }
                        html = html + '<li><div class="block"><div class="block_content"><h2 class="title">' +
                            '<span>发布项目：' + ret[i].project + '</span></h2><div class="byline">' +
                            '<span>发布时间：' + ret[i].created_time + '</span> by ' +
                            '<span>' + ret[i].user + '</span></div>' +
                            '<p class="excerpt">任务ID：' + ret[i].jid + '，发布批次：' + ret[i].batch + '，发布类型：项目' +
                            msg + '，发布结果：' + status + '.</p></div> </div></li>';
                    }
                    $("#append_log").append(html);
                    num = lid + 1;
                    $("#log-info a").attr("onclick", "log_info(" + num + ");");
                }
            })
        }

        function get_info() {
            $.ajax({
                type: "POST",
                url: "{% url 'index' %}",
                data: {req_type: 'info'},
                dataType: "json",
                success: function (ret) {
                    $.each(ret, function (i, item) {
                        $("#" + i).html(item);
                    })
                }
            })
        }

        function get_sys_usage() {
            $.ajax({
                type: "POST",
                url: "{% url 'index' %}",
                data: {req_type: 'sys'},
                dataType: "json",
                success: function (ret) {
                    $("#boot_time").html(ret.boot_time);
                    if(Math.round(ret.online_time/3600/24) > 1){
                        online = Math.round(ret.online_time/3600/24) + ' 天';
                    }else if(Math.round(ret.online_time/3600) > 1){
                        online = Math.round(ret.online_time/3600) + ' 小时';
                    }else{
                        online = Math.round(ret.online_time/60) + ' 分钟';
                    }
                    $("#online_time").html(online);
                    $("#cpu").attr("aria-valuenow", ret.cpu_percent).css("width", ret.cpu_percent + "%");
                    $("#cpu_per").html(ret.cpu_percent);
                    $("#mem").attr("aria-valuenow", ret.mem_percent).css("width", ret.mem_percent + "%");
                    $("#mem_per").html(ret.mem_percent);
                    $.each(ret.disk_info, function (i, item) {
                        $("#disk-" + i).attr("aria-valuenow", item[3]).css("width", item[3] + "%");
                        $("#disk-per-" + i).html(item[3]);
                    })
                }
            })
        }
        // 基于准备好的dom，初始化echarts实例
        var myChart = echarts.init(document.getElementById('main'));

        // 指定图表的配置项和数据
        var option = {
            color: ['#18BC9C', '#006699'],
            title: {
                text: ''
            },
            tooltip: {
                trigger: 'axis',
                //formatter: '{a0}:{c0}Kb/s<br />{a1}:{c1}Kb/s',
                axisPointer: {
                    type: 'cross',
                    label: {
                        backgroundColor: '#6a7985'
                    }
                }
            },
            legend: {
                top: 'left',
                data: ['上传速率', '下载速率']
            },
            toolbox: {
                show: true,
                feature: {
                    saveAsImage: {}
                }
            },
            grid: {
                left: '3%',
                right: '4%',
                bottom: '3%',
                containLabel: true
            },
            xAxis: [
                {
                    type: 'category',
                    boundaryGap: false,
                    axisLabel: {
                        formatter: function (value, index) {
{#                        var date = new Date(value);#}
{#                        var texts = [(date.getMonth() + 1), date.getDate()];#}
                        var texts = value.split('-');
{#                        console.log(texts[0]);#}
{#                        if (index === 0) {#}
{#                            return texts[0];#}
{#                        }#}
                        return texts[1] + '-' + texts[2];
                    }
                    },
                    data: []
                }
            ],
            yAxis: [
                {
                    name: '速率(Kb/s)',
                    type: 'value'
                }
            ],
            series: [
                {
                    name: '上传速率',
                    type: 'line',
                    areaStyle: {normal: {}},
                    data: []
                },
                {
                    name: '下载速率',
                    type: 'line',
                    /*label: {
                     normal: {
                     show: true,
                     position: 'top'
                     }
                     },*/
                    areaStyle: {normal: {}},
                    data: []
                }
            ]
        };

        // 使用刚指定的配置项和数据显示图表。
        myChart.setOption(option);

        getNetInfo();

        function getNetInfo() {
            var options = myChart.getOption();
            $.ajax({
                type: "POST",
                url: "{% url 'index' %}",
                data: {req_type: 'netinfo'},
                dataType: "json",
                success: function (ret) {
                    options.xAxis[0].data = ret.x_data_0;
		    //options.xAxis[0].data = ret.x_data;
                    options.series[0].data = ret.net_out;
                    options.series[1].data = ret.net_in;
                    myChart.setOption(options);
                }
            })
        }


        // 基于准备好的dom，初始化echarts实例
        var appChart = echarts.init(document.getElementById('main-release'));

        // 指定图表的配置项和数据
        var app_option = {
            color: ['#18BC9C', '#d9534f'],
            title: {
                text: '最近两周发布情况',
                textStyle: {
                    fontSize: 14,
                    //fontWeight: 'bolder',
                    color: '#73879C'
                }
            },
            tooltip: {
                trigger: 'axis',
                axisPointer: { // 坐标轴指示器，坐标轴触发有效
                    type: 'shadow' // 默认为直线，可选为：'line' | 'shadow'
                }
            },
            legend: {
                data: ['发布成功', '发布失败'],
                align: 'right',
                right: 10
            },
            grid: {
                left: '3%',
                right: '4%',
                bottom: '3%',
                containLabel: true
            },
            xAxis: [{
                type: 'category',
                data: []
            }],
            yAxis: [{
                type: 'value',
                name: '数量',
                axisLabel: {
                    formatter: '{value}'
                }
            }],
            series: [
                {
                    name: '发布成功',
                    type: 'bar',
                    data: []
                },
                {
                    name: '发布失败',
                    type: 'bar',
                    data: []
                }
            ]
        };

        // 使用刚指定的配置项和数据显示图表。
        appChart.setOption(app_option);

        getData();

        function getData() {
            var options = appChart.getOption();
            $.ajax({
                type: "POST",
                url: "{% url 'index' %}",
                data: {req_type: 'appchart'},
                dataType: "json",
                success: function (ret) {
                    console.log(ret.x_data);
                    console.log(ret.y_data_succ);
                    console.log(ret.y_data_fail);
                    options.xAxis[0].data = ret.x_data;
                    options.series[0].data = ret.y_data_succ;
                    options.series[1].data = ret.y_data_fail;
                    appChart.setOption(options);
                }
            })
        }
    </script>
{% endblock %}

